<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCB Strategic Pricing Portal | Institutional Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 100% ORIGINAL STYLES MAINTAINED */
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 12px 24px; cursor: pointer; border: none; background: #e2e8f0; border-radius: 6px; font-weight: bold; color: #475569; transition: 0.3s; }
        .tab-btn.active { background: #1e3a8a; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .header-flex { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 3px solid #1e3a8a; padding-bottom: 15px; }
        .controls { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .slider-group { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.95em; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        th { background-color: #1e3a8a; color: white; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .impact-box { padding: 20px; border-radius: 8px; font-size: 1.1em; font-weight: bold; text-align: center; border: 2px solid #eee; transition: 0.5s; }
        .margin-box { background: #1e3a8a !important; color: white !important; }
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .chart-wrapper { height: 260px; position: relative; }
        .btn { background: #10b981; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 1em; }
        
        /* ENHANCED INTELLIGENCE STYLES */
        .intel-header { background: #1e3a8a; color: white; padding: 15px; border-radius: 8px 8px 0 0; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .intel-body { border: 1px solid #e2e8f0; padding: 25px; border-radius: 0 0 8px 8px; background: #fff; line-height: 1.6; }
        .data-stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 6px; text-align: center; }
        .stat-val { display: block; font-size: 1.4em; font-weight: 800; color: #1e3a8a; }
        .stat-label { font-size: 0.75em; color: #64748b; text-transform: uppercase; font-weight: bold; }
        
        /* STABLE HEATMAP STYLES */
        .heatmap-box { position: relative; background: #0f172a; border-radius: 12px; padding: 30px; margin: 20px 0; border: 1px solid #334155; }
        .map-node { fill: #38bdf8; cursor: pointer; transition: all 0.3s; filter: drop-shadow(0 0 5px rgba(56, 189, 248, 0.5)); }
        .map-node:hover { fill: #fb923c; r: 12; filter: drop-shadow(0 0 10px rgba(251, 146, 60, 0.8)); }
        .map-label { fill: #94a3b8; font-size: 10px; font-weight: bold; pointer-events: none; }
        #map-tooltip { position: absolute; background: rgba(15, 23, 42, 0.95); color: white; padding: 12px; border-radius: 6px; display: none; font-size: 12px; z-index: 1000; border: 1px solid #38bdf8; min-width: 180px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
        
        @media print { .no-print { display: none; } .container { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<script>
    const PASSWORD = "mcb26"; 
    let entered = "";
    while (entered !== PASSWORD) {
        entered = prompt("INTERNAL ACCESS ONLY: Enter 2026 Sales Portal Code:");
        if (entered === null) { document.body.innerHTML = "<h1>Unauthorized Access</h1>"; break; }
    }
</script>

<div class="container">
    <div class="header-flex">
        <div>
            <h2 style="color:#1e3a8a; margin:0; letter-spacing: -0.5px;">MCB Institutional Pricing & Intelligence</h2>
            <p style="margin:5px 0 0 0; color:#64748b; font-size: 0.9em;"><strong>Reference:</strong> STRAT-2026-Q1 | <strong>Market State:</strong> Structural Deficit</p>
        </div>
        <div style="text-align:right;">
            <div style="font-size: 1.8em; font-weight: 900; color: #1e3a8a;">M<span style="color:#f97316">C</span>B</div>
            <div style="font-size: 0.7em; color: #94a3b8; font-weight: bold;">METALS & COMPONENTS BUREAU</div>
        </div>
    </div>

    <div class="tabs no-print">
        <button class="tab-btn active" onclick="openTab('calc')">Margin Calculator</button>
        <button class="tab-btn" onclick="openTab('history')">LME/Spot Trends</button>
        <button class="tab-btn" onclick="openTab('intel')">Institutional Intelligence</button>
    </div>

    <div id="calc" class="tab-content active">
        <div id="report-content">
            <div class="controls no-print">
                <div class="slider-group">
                    <div class="slider-label"><span>Silver (Ag) Price Shift:</span> <span id="agLabel" style="color:#2563eb;">0%</span></div>
                    <input type="range" id="agSlider" min="-10" max="100" value="0" style="width:100%" oninput="updateCosts()">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>Copper (Cu) Price Shift:</span> <span id="cuLabel" style="color:#b45309;">0%</span></div>
                    <input type="range" id="cuSlider" min="-10" max="100" value="0" style="width:100%" oninput="updateCosts()">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>Target Profit Margin:</span> <span id="marginLabel" style="color:#10b981;">20%</span></div>
                    <input type="range" id="marginSlider" min="-20" max="100" value="20" style="width:100%" oninput="updateCosts()">
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Component Group</th><th>Base Material</th><th>Base Cost (FY25)</th><th>Adjusted Cost (2026)</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div class="result-grid">
                <div id="totalImpact" class="impact-box">Calculating...</div>
                <div id="sellingPriceBox" class="impact-box margin-box">Calculating...</div>
            </div>
            <button class="btn no-print" onclick="downloadPDF()">Generate Executive Quote Summary (PDF)</button>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div style="display:flex; justify-content: center; gap:10px; margin-bottom: 20px;" class="no-print">
            <button class="tab-btn" style="padding: 5px 15px; font-size: 0.8em;" onclick="updateTimeframe('6M')">6M</button>
            <button class="tab-btn" style="padding: 5px 15px; font-size: 0.8em;" onclick="updateTimeframe('1Y')">1Y</button>
            <button class="tab-btn" style="padding: 5px 15px; font-size: 0.8em;" onclick="updateTimeframe('3Y')">3Y</button>
            <button class="tab-btn active" id="btn10y" style="padding: 5px 15px; font-size: 0.8em;" onclick="updateTimeframe('10Y')">10Y</button>
        </div>
        <div class="chart-grid">
            <div><h4 style="text-align:center;">Copper LME Grade A (USD/mt)</h4><div class="chart-wrapper"><canvas id="copperChart"></canvas></div></div>
            <div><h4 style="text-align:center;">Silver Spot Price (USD/oz)</h4><div class="chart-wrapper"><canvas id="silverChart"></canvas></div></div>
        </div>
    </div>

    <div id="intel" class="tab-content">
        <div class="data-stat-grid">
            <div class="stat-card"><span class="stat-label">Cu Deficit 2026</span><span class="stat-val">330kmt</span></div>
            <div class="stat-card"><span class="stat-label">Ag Deficit (6th Yr)</span><span class="stat-val">67 Moz</span></div>
            <div class="stat-card"><span class="stat-label">AI Demand Growth</span><span class="stat-val">+110kt/yr</span></div>
            <div class="stat-card"><span class="stat-label">Chile Ore Grade</span><span class="stat-val">-4.2%</span></div>
        </div>

        <div class="intel-header">
            <h3 style="margin:0;">Global Production & Supply-Chain Risk Matrix</h3>
            <span style="font-size: 0.7em; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;">DATA SOURCE: LME / WORLD SILVER COUNCIL</span>
        </div>
        <div class="intel-body">
            <div class="heatmap-box">
                <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50,100 L250,100 L280,350 L80,350 Z" fill="#1e293b"/> <path d="M350,50 L750,50 L780,300 L380,300 Z" fill="#1e293b"/> <circle cx="180" cy="150" r="8" class="map-node" onmouseover="showTip(event, 'MEXICO (Ag Lead)', '6.3K Tonnes/yr', '10Y Trend: Stable', 'Primary Ag source for global electronics.')"/>
                    <text x="145" y="170" class="map-label">MEXICO</text>

                    <circle cx="230" cy="290" r="10" class="map-node" onmouseover="showTip(event, 'CHILE (Cu Super-hub)', '5.3M Tonnes/yr', '10Y Trend: -4.2%', 'Severe ore grade depletion. Water scarcity risks.')"/>
                    <text x="210" y="315" class="map-label">CHILE</text>

                    <circle cx="480" cy="240" r="9" class="map-node" onmouseover="showTip(event, 'DR CONGO (Growth Hub)', '3.3M Tonnes/yr', '10Y Trend: +1450%', 'Massive output surge but high Durban port logistics risk.')"/>
                    <text x="450" y="265" class="map-label">DRC</text>

                    <circle cx="680" cy="120" r="10" class="map-node" onmouseover="showTip(event, 'CHINA (Refinement)', '1.8M Tonnes Cu', '10Y Trend: +22%', 'Dominates 65% of global copper smelting capacity.')"/>
                    <text x="655" y="145" class="map-label">CHINA</text>

                    <circle cx="620" cy="200" r="7" class="map-node" onmouseover="showTip(event, 'INDIA (Demand Driver)', 'Emerging Cu Hub', '10Y Trend: +180%', 'Massive infrastructure & smart city expansion.')"/>
                    <text x="600" y="225" class="map-label">INDIA</text>
                </svg>
                <div id="map-tooltip"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h4 style="color:#1e3a8a; border-bottom: 2px solid #f97316; padding-bottom: 5px;">Copper Intelligence Outlook</h4>
                    <p style="font-size: 0.9em; text-align: justify;">
                        Institutional consensus from **J.P. Morgan** and **Deutsche Bank** indicates an average copper price of **$12,075/mt** for 2026. The deficit is widening to **330 kmt** due to stagnant mine supply growth (+1.4%).
                        <br><br>
                        <strong>Key Fact:</strong> AI Data Center installations will consume **475 kmt** of copper in 2026, a 30% increase vs 2025. Chile’s state agency (Cochilco) has lowered 2026 forecasts to **5.61M tonnes** due to operational setbacks.
                    </p>
                </div>
                <div>
                    <h4 style="color:#1e3a8a; border-bottom: 2px solid #2563eb; padding-bottom: 5px;">Silver Institutional Briefing</h4>
                    <p style="font-size: 0.9em; text-align: justify;">
                        The **Silver Institute** confirms a 6th consecutive year of deficit (**67 Moz**). While PV solar manufacturers are "thrifting" silver usage, this is offset by explosive demand in **Smart Vehicles** and **Semiconductors**.
                        <br><br>
                        <strong>Risk Warning:</strong> Spot prices recently breached the **$100/oz** threshold. Institutional holders are treating silver as a high-beta play on industrial electrification, ensuring a high price floor despite solar substitution.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LIVE SYNC CONFIGURATION ---
    const API_KEY = "REPLACE_WITH_YOUR_FREE_KEY"; // Get free key at metals-api.com
    const BASE_CU_FY25 = 8400; // Baseline Copper $/mt
    const BASE_AG_FY25 = 23;   // Baseline Silver $/oz

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // 100% ORIGINAL CALCULATOR LOGIC
    const bomData = [
        { comp: "Contact Tips (Ag-Heavy)", mat: "Silver", cost: 0.28, type: "ag" },
        { comp: "Bimetal Strip Assembly", mat: "Copper", cost: 0.18, type: "cu" },
        { comp: "Housing Material", mat: "PA66", cost: 0.45, type: "fixed" },
        { comp: "Arc Chute Frame", mat: "Steel", cost: 0.09, type: "fixed" },
        { comp: "Labor & Logistics", mat: "Labor", cost: 0.20, type: "fixed" }
    ];

    function updateCosts() {
        const agShift = document.getElementById('agSlider').value;
        const cuShift = document.getElementById('cuSlider').value;
        const margin = document.getElementById('marginSlider').value;
        document.getElementById('agLabel').innerText = agShift + "%";
        document.getElementById('cuLabel').innerText = cuShift + "%";
        document.getElementById('marginLabel').innerText = margin + "%";

        let totalCost = 0; let baseTotal = 1.20;
        let tableHTML = "";
        bomData.forEach(item => {
            let shift = item.type === 'ag' ? agShift : (item.type === 'cu' ? cuShift : 0);
            let current = item.cost * (1 + (shift / 100));
            totalCost += current;
            tableHTML += `<tr><td>${item.comp}</td><td>${item.mat}</td><td>$${item.cost.toFixed(2)}</td><td style="${shift != 0 ? 'color:#dc2626; font-weight:bold;' : ''}">$${current.toFixed(2)}</td></tr>`;
        });
        document.getElementById('tableBody').innerHTML = tableHTML;
        const costInc = ((totalCost - baseTotal) / baseTotal) * 100;
        const targetPrice = totalCost / (1 - (margin / 100));
        
        const impactBox = document.getElementById('totalImpact');
        const priceBox = document.getElementById('sellingPriceBox');
        
        impactBox.innerHTML = `Cost Basis: $${totalCost.toFixed(2)}<br><span style="font-size:0.7em; color:${costInc > 0 ? '#dc2626' : '#10b981'};">Inflation: ${costInc.toFixed(1)}%</span>`;
        priceBox.innerHTML = `Target Quote: $${targetPrice.toFixed(2)}<br><span style="font-size:0.7em;">At ${margin}% Margin</span>`;

        // ALERT TRIGGER: If margin drops too low due to market sync
        if (margin < 15) {
            priceBox.style.background = "#dc2626";
        } else {
            priceBox.style.background = "#1e3a8a";
        }
    }

    // NEW: DAILY MARKET SYNC FUNCTION
    async function syncDailyMarket() {
        if(API_KEY === "REPLACE_WITH_YOUR_FREE_KEY") {
            console.log("No API Key detected. Live sync disabled.");
            return;
        }

        try {
            const response = await fetch(`https://metals-api.com/api/latest?access_key=${API_KEY}&symbols=XCU,XAG`);
            const data = await response.json();
            
            if(data.success) {
                const liveCu = 1 / data.rates.XCU; // Adjust based on API return format
                const liveAg = 1 / data.rates.XAG;

                const cuShift = ((liveCu - BASE_CU_FY25) / BASE_CU_FY25) * 100;
                const agShift = ((liveAg - BASE_AG_FY25) / BASE_AG_FY25) * 100;

                document.getElementById('cuSlider').value = cuShift.toFixed(0);
                document.getElementById('agSlider').value = agShift.toFixed(0);
                
                updateCosts();

                if (cuShift > 20 || agShift > 20) {
                    alert("⚠️ LME NOTICE: Daily refresh detected a price surge > 20% compared to FY25 baseline.");
                }
            }
        } catch (e) {
            console.warn("Market Sync Connection Failed. Proceeding with manual input.");
        }
    }

    // MAP TOOLTIP LOGIC
    const tip = document.getElementById('map-tooltip');
    function showTip(e, country, prod, trend, risk) {
        tip.style.display = 'block';
        tip.innerHTML = `<b style="color:#38bdf8; font-size:1.1em;">${country}</b><br><b>Output:</b> ${prod}<br><b>Outlook:</b> ${trend}<br><p style="margin-top:5px; font-style:italic; border-top:1px solid #334155; padding-top:5px;">${risk}</p>`;
        tip.style.left = (e.pageX + 20) + 'px';
        tip.style.top = (e.pageY - 50) + 'px';
    }
    document.querySelector('svg').onmouseleave = () => tip.style.display = 'none';

    // 100% ORIGINAL TRENDS DATA
    const marketData = {
        '6M': { labels: ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'], cu: [8400, 8900, 9100, 9800, 11200, 12075], ag: [24, 26, 28, 32, 78, 87] },
        '10Y': { labels: ['2016', '2018', '2020', '2022', '2024', '2026'], cu: [4700, 6500, 6200, 9500, 8400, 12075], ag: [16, 15, 20, 24, 23, 87] }
    };

    let cuChart, agChart;
    window.onload = function() {
        const cuCtx = document.getElementById('copperChart').getContext('2d');
        cuChart = new Chart(cuCtx, { type: 'line', data: { labels: marketData['10Y'].labels, datasets: [{ label: 'Copper (USD/mt)', data: marketData['10Y'].cu, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.3 }] }, options: { maintainAspectRatio: false } });
        const agCtx = document.getElementById('silverChart').getContext('2d');
        agChart = new Chart(agCtx, { type: 'line', data: { labels: marketData['10Y'].labels, datasets: [{ label: 'Silver (USD/oz)', data: marketData['10Y'].ag, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3 }] }, options: { maintainAspectRatio: false } });
        
        updateCosts();
        syncDailyMarket(); // Run sync on launch
    };

    function updateTimeframe(p) {
        const d = marketData[p] || marketData['10Y'];
        cuChart.data.labels = d.labels; cuChart.data.datasets[0].data = d.cu; cuChart.update();
        agChart.data.labels = d.labels; agChart.data.datasets[0].data = d.ag; agChart.update();
    }

    function downloadPDF() { html2pdf().from(document.getElementById('report-content')).save('MCB_Market_Pricing_2026.pdf'); }
</script>
</body>
</html>